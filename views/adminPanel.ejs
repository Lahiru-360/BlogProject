<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel | Bloggy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#6366f1",
            },
          },
        },
      };
    </script>
    <style>
      body {
        transition: background-color 0.3s, color 0.3s;
      }
    </style>
  </head>

  <body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100">
    <% const days=["Sun", "Mon" , "Tue" , "Wed" , "Thurs" , "Fri" , "Sat" ]; %>

    <!-- Mobile Toggle Button -->
    <button
      id="menu-toggle"
      class="lg:hidden fixed top-4 left-4 z-50 p-2 rounded-md bg-indigo-600 text-white shadow-lg"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M4 6h16M4 12h16M4 18h16"
        />
      </svg>
    </button>

    <!-- Dark mode toggle -->
    <button
      id="theme-toggle"
      class="fixed bottom-5 z-50 right-5 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-md transition duration-300"
    >
      <svg
        id="sun-icon"
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
        ></path>
      </svg>
      <svg
        id="moon-icon"
        class="w-6 h-6 hidden"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9 9 0 008.354-5.646z"
        ></path>
      </svg>
    </button>

    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="w-64 bg-white dark:bg-gray-800 shadow-lg fixed inset-y-0 left-0 z-40 overflow-y-auto transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out"
    >
      <div class="p-6 font-bold text-2xl text-indigo-600 dark:text-indigo-400">
        Bloggy Admin
      </div>
      <nav class="mt-6 space-y-2 text-sm font-medium">
        <a
          href="#dashboard"
          class="block py-2 px-6 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded"
          >üìä Dashboard</a
        >
        <a
          href="#users"
          class="block py-2 px-6 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded"
          >üë§ Users</a
        >
        <a
          href="#blogs"
          class="block py-2 px-6 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded"
          >üìù Blogs</a
        >
        <a
          href="#approvals"
          class="block py-2 px-6 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded"
          >‚úÖ Approvals</a
        >
        <a
          href="#settings"
          class="block py-2 px-6 hover:bg-indigo-50 dark:hover:bg-gray-700 rounded"
          >‚öôÔ∏è Settings</a
        >
        <a
          href="/logout"
          class="block py-2 px-6 text-red-600 hover:bg-red-100 dark:hover:bg-red-800 rounded"
          >üö™ Logout</a
        >
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="min-h-screen pt-10 lg:ml-10 p-6 lg:pl-64 space-y-14">
      <!-- Dashboard -->
      <section id="dashboard">
        <h2 class="text-3xl font-bold mb-6">Dashboard Overview</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl shadow-md">
            <p class="text-sm text-gray-500">Total Users</p>
            <p class="text-3xl font-bold text-indigo-600">
              <%= userCount - 1 || "0" %>
            </p>
          </div>
          <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl shadow-md">
            <p class="text-sm text-gray-500">Total Blogs</p>
            <p class="text-3xl font-bold text-indigo-600">
              <%= blogCount || "0" %>
            </p>
          </div>
          <div class="p-5 bg-white dark:bg-gray-800 rounded-2xl shadow-md">
            <p class="text-sm text-gray-500">Pending Approvals</p>
            <p class="text-3xl font-bold text-indigo-600">
              <%= approveBlogsCount || "0" %>
            </p>
          </div>
        </div>
      </section>

      <!-- Users -->
      <section id="users">
        <h2 class="text-3xl font-bold mb-6">Manage Users</h2>
        <div
          class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl shadow"
        >
          <table class="min-w-full text-sm">
            <thead
              class="bg-indigo-100 dark:bg-indigo-800 text-indigo-900 dark:text-white"
            >
              <tr>
                <th class="p-4 text-left">ID</th>
                <th class="p-4 text-left">Name</th>
                <th class="p-4 text-left">Email</th>
                <th class="p-4 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (users && users.filter(u => u.id != -1).length > 0) { %> <%
              users.forEach((user) => { %> <% if (user.id != -1) { %>
              <tr class="border-t border-gray-200 dark:border-gray-700">
                <td class="p-4"><%= user.id %></td>
                <td class="p-4"><%= user.firstname %> <%= user.lastname %></td>
                <td class="p-4"><%= user.email %></td>
                <td class="p-4 space-x-2">
                  <form
                    onsubmit="confirmDelete(event, this)"
                    method="GET"
                    action="/delete/<%= user.id %>"
                    class="inline"
                  >
                    <button
                      type="submit"
                      class="px-3 py-1 bg-red-500 text-white rounded"
                    >
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
              <% } %> <% }) %> <% } else { %>
              <tr>
                <td class="p-4 text-center" colspan="4">No users found.</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Blogs -->
      <section id="blogs">
        <h2 class="text-3xl font-bold mb-6">All Blogs</h2>
        <div
          class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl shadow"
        >
          <table class="min-w-full text-sm">
            <thead
              class="bg-indigo-100 dark:bg-indigo-800 text-indigo-900 dark:text-white"
            >
              <tr>
                <th class="p-4 text-left">ID</th>
                <th class="p-4 text-left">Title</th>
                <th class="p-4 text-left">Category</th>
                <th class="p-4 text-left">Author</th>
                <th class="p-4 text-left">Date</th>
                <th class="p-4 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (blogs && blogs.length > 0) { %> <% blogs.forEach((blog) =>
              { %>
              <tr class="border-t border-gray-200 dark:border-gray-700">
                <td class="p-4"><%= blog.id %></td>
                <td class="p-4"><%= blog.blogname %></td>
                <td class="p-4"><%= blog.category %></td>
                <td class="p-4"><%= blog.firstname %> <%= blog.lastname %></td>
                <td class="p-4">
                  <% if (blog.published_at) { %> <%=
                  days[blog.published_at.getDay()] %> <%=
                  (blog.published_at.getMonth() + 1) %>/ <%=
                  blog.published_at.getDate() %>/ <%=
                  blog.published_at.getFullYear() %> <%=
                  blog.published_at.getHours().toString().padStart(2, '0') %>:
                  <%= blog.published_at.getMinutes().toString().padStart(2, '0')
                  %>: <%= blog.published_at.getSeconds().toString().padStart(2,
                  '0') %> <% } else { %> Not Published Yet <% } %>
                </td>

                <td class="p-4 space-x-2">
                  <a
                    href="/blog/<%= blog.id %>"
                    class="px-3 py-1 bg-indigo-600 text-white rounded"
                    >View</a
                  >
                  <form
                    onsubmit="deleteBlogHandle(event, this)"
                    method="GET"
                    action="/deleteblog/<%= blog.id %>"
                    class="inline"
                  >
                    <button
                      type="submit"
                      class="px-3 py-1 bg-[#ef4444] text-white rounded"
                    >
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
              <% }) %> <% } else { %>
              <tr>
                <td class="p-4 text-center" colspan="6">No blogs found.</td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Approvals -->
      <section id="approvals">
        <h2 class="text-3xl font-bold mb-6">Pending Blog Approvals</h2>
        <div
          class="overflow-x-auto bg-white dark:bg-gray-800 rounded-xl shadow"
        >
          <table class="min-w-full text-sm">
            <thead
              class="bg-indigo-100 dark:bg-indigo-800 text-indigo-900 dark:text-white"
            >
              <tr>
                <th class="p-4 text-left">ID</th>
                <th class="p-4 text-left">Title</th>
                <th class="p-4 text-left">Category</th>
                <th class="p-4 text-left">Author</th>
                <th class="p-4 text-left">Date</th>
                <th class="p-4 text-left">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (approveBlogData && approveBlogData.length > 0) { %> <%
              approveBlogData.forEach(blog => { %>
              <tr class="border-t border-gray-200 dark:border-gray-700">
                <td class="p-4"><%= blog.id %></td>
                <td class="p-4"><%= blog.blogname %></td>
                <td class="p-4"><%= blog.category %></td>
                <td class="p-4"><%= blog.firstname %> <%= blog.lastname %></td>
                <td class="p-4">
  <% if (blog.published_at) { %>
    <%= days[blog.published_at.getDay()] %>
    <%= blog.published_at.getMonth() + 1 %>/
    <%= blog.published_at.getDate() %>/
    <%= blog.published_at.getFullYear() %>
    <%= blog.published_at.getHours().toString().padStart(2, '0') %>:
    <%= blog.published_at.getMinutes().toString().padStart(2, '0') %>:
    <%= blog.published_at.getSeconds().toString().padStart(2, '0') %>
  <% } else { %>
    <%= days[blog.created_at.getDay()] %>
    <%= blog.created_at.getMonth() + 1 %>/
    <%= blog.created_at.getDate() %>/
    <%= blog.created_at.getFullYear() %>
    <%= blog.created_at.getHours().toString().padStart(2, '0') %>:
    <%= blog.created_at.getMinutes().toString().padStart(2, '0') %>:
    <%= blog.created_at.getSeconds().toString().padStart(2, '0') %>
  <% } %>
</td>


                <td class="p-4 space-x-2">
                  <a
                    href="/blog/<%= blog.id %>"
                    class="px-3 py-1 bg-indigo-600 text-white rounded"
                    >View</a
                  >

                  <a
                    href="#"
                    onclick="event.preventDefault(); document.querySelector('#approve-form-<%= blog.id %> button[type=submit]').click();"
                    class="px-3 py-1 bg-green-500 text-white rounded"
                    >Approve</a
                  >

                  <form
                    onsubmit="approveHandle(event, this)"
                    id="approve-form-<%= blog.id %>"
                    method="POST"
                    action="/approveblog/<%= blog.id %>"
                    style="display: none"
                  >
                    <button type="submit"></button>
                  </form>

                  <a
                    href="#"
                    onclick="event.preventDefault(); document.querySelector('#reject-form-<%= blog.id %> button[type=submit]').click();"
                    class="px-3 py-1 bg-red-500 text-white rounded"
                    >Reject</a
                  >

                  <form
                    onsubmit="rejectHandle(event, this)"
                    id="reject-form-<%= blog.id %>"
                    method="POST"
                    action="/rejectblog/<%= blog.id %>"
                    style="display: none"
                  >
                    <button type="submit"></button>
                  </form>
                </td>
              </tr>
              <% }) %> <% } else { %>
              <tr>
                <td class="p-4 text-center" colspan="6">
                  No blogs require approval.
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Settings -->
      <section id="settings">
        <h2 class="text-3xl font-bold mb-6">Site Settings</h2>
        <p class="text-gray-600 dark:text-gray-300">
          Settings UI coming soon...
        </p>
      </section>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
      const htmlElement = document.documentElement;
      const themeToggleBtn = document.getElementById("theme-toggle");
      const sunIcon = document.getElementById("sun-icon");
      const moonIcon = document.getElementById("moon-icon");

      // Theme toggle
      if (
        localStorage.getItem("theme") === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        htmlElement.classList.add("dark");
        sunIcon.classList.add("hidden");
        moonIcon.classList.remove("hidden");
      } else {
        htmlElement.classList.remove("dark");
        sunIcon.classList.remove("hidden");
        moonIcon.classList.add("hidden");
      }

      themeToggleBtn.addEventListener("click", () => {
        if (htmlElement.classList.contains("dark")) {
          htmlElement.classList.remove("dark");
          localStorage.setItem("theme", "light");
          sunIcon.classList.remove("hidden");
          moonIcon.classList.add("hidden");
        } else {
          htmlElement.classList.add("dark");
          localStorage.setItem("theme", "dark");
          sunIcon.classList.add("hidden");
          moonIcon.classList.remove("hidden");
        }
      });

      // Mobile sidebar toggle
      const menuToggle = document.getElementById("menu-toggle");
      const sidebar = document.getElementById("sidebar");

      menuToggle.addEventListener("click", () => {
        sidebar.classList.toggle("-translate-x-full");
      });

      function rejectHandle(event, form) {
        event.preventDefault();
        const isDark = document.documentElement.classList.contains("dark");

        Swal.fire({
          title: "Are you sure?",
          text: "You are about to reject this blog post!",
          icon: "warning",
          theme: isDark ? "dark" : "light",
          showCancelButton: true,
          iconColor: "#d33",
          confirmButtonColor: "#d33",
          cancelButtonColor: "#6362F1",
          confirmButtonText: "Reject",
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      }

      function approveHandle(event, form) {
        event.preventDefault();
        const isDark = document.documentElement.classList.contains("dark");

        Swal.fire({
          title: "Approve blog?",
          text: "This blog post will be marked as approved.",
          icon: "question",
          theme: isDark ? "dark" : "light",
          showCancelButton: true,
          iconColor: "#22c55e",
          confirmButtonColor: "#22c55e",
          cancelButtonColor: "#d33",
          confirmButtonText: "Approve",
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      }

      function confirmDelete(event, form) {
        event.preventDefault();
        const isDark = document.documentElement.classList.contains("dark");

        Swal.fire({
          title: "Are you sure?",
          text: "This user will be deleted permanently!",
          icon: "warning",
          iconColor: "#d33",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#6366F1",
          confirmButtonText: "Delete",
          background: isDark ? "#1f2937" : "#fff",
          color: isDark ? "#fff" : "#000",
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      }

      function deleteBlogHandle(event, form) {
        event.preventDefault();
        const isDark = document.documentElement.classList.contains("dark");

        Swal.fire({
          title: "Are you sure?",
          text: "This blog will be permanently deleted!",
          icon: "warning",
          iconColor: "#d33",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#6366f1",
          confirmButtonText: "Delete",
          background: isDark ? "#1f2937" : undefined,
          color: isDark ? "#fff" : undefined,
        }).then((result) => {
          if (result.isConfirmed) {
            form.submit();
          }
        });
      }
    </script>
  </body>
</html>
